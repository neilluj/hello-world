from snowflake.snowpark import functions as F

def operaciones_periodo(df, col_fecha: str, col_operacion: str, col_usuario: str, m: str):
    """
    Calcula el número de operaciones realizadas por usuario y operación
    en los periodos actual, t-1, t-2 y t-3 (mensual o semanal).

    Parámetros:
    - df: DataFrame de Snowpark
    - col_fecha: nombre de la columna con la fecha (varchar)
    - col_operacion: nombre de la columna con el ID de la operación
    - col_usuario: nombre de la columna con el ID del usuario
    - m: 'mensual' o 'semanal'
    """
    
    # Limpiar formato de fecha (solo primeros 10 caracteres)
    df = df.with_column("FECHA_LIMPIA", F.to_date(F.substring(F.col(col_fecha), 1, 10)))
    
    # Crear columna de periodo según el modo
    if m == "mensual":
        df = df.with_column("PERIODO", F.date_trunc("month", F.col("FECHA_LIMPIA")))
        delta = "month"
    elif m == "semanal":
        df = df.with_column("PERIODO", F.date_trunc("week", F.col("FECHA_LIMPIA")))
        delta = "week"
    else:
        raise ValueError("El parámetro m debe ser 'mensual' o 'semanal'")
    
    # Contar operaciones por usuario, operación y periodo
    base = (
        df.group_by(col_usuario, col_operacion, "PERIODO")
        .agg(F.count("*").alias("OPERACIONES"))
    )
    
    # Unir con los periodos desplazados (t-1, t-2, t-3)
    for i in [1, 2, 3]:
        base = base.join(
            base.select(
                F.col(col_usuario).alias("USR_JOIN"),
                F.col(col_operacion).alias("OP_JOIN"),
                F.dateadd(delta, i, F.col("PERIODO")).alias("PERIODO_JOIN"),
                F.col("OPERACIONES").alias(f"OPERACIONES_T-{i}")
            ),
            (F.col(col_usuario) == F.col("USR_JOIN")) &
            (F.col(col_operacion) == F.col("OP_JOIN")) &
            (F.col("PERIODO") == F.col("PERIODO_JOIN")),
            how="left"
        ).drop("USR_JOIN", "OP_JOIN", "PERIODO_JOIN")

    # Rellenar nulos con 0
    for i in [1, 2, 3]:
        base = base.with_column(f"OPERACIONES_T-{i}", F.coalesce(F.col(f"OPERACIONES_T-{i}"), F.lit(0)))
    
    return base